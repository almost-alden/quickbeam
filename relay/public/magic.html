<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quickbeam | Welcome!</title>
    <style>
        :root { --primary: #673ab7; --bg: #f5f5f7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 1.5rem; text-align: center; color: #1d1d1f; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .avatar { width: 80px; height: 80px; background: #eee; border-radius: 50%; margin: 0 auto 1.5rem; display: flex; align-items: center; justify-content: center; font-size: 2rem; border: 4px solid var(--primary); }
        h1 { font-size: 1.5rem; margin-bottom: 0.5rem; }
        .message { font-size: 1.1rem; line-height: 1.4; color: #444; margin-bottom: 2rem; }
        .video-box { background: #f9f9f9; padding: 1rem; border-radius: 12px; margin-bottom: 2rem; border-left: 5px solid var(--primary); text-align: left; }
        .video-label { font-size: 0.7rem; color: #888; text-transform: uppercase; font-weight: bold; }
        .video-title { font-weight: 600; color: #333; }
        .btn { padding: 1.2rem 2.5rem; font-size: 1.2rem; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; transition: transform 0.2s, background 0.2s; width: 100%; box-shadow: 0 4px 15px rgba(103, 58, 183, 0.3); }
        .btn:active { transform: scale(0.98); }
        .status { margin-top: 2rem; font-size: 0.85rem; padding: 0.8rem; border-radius: 8px; }
        .status.finding { background: #fffde7; color: #f57f17; }
        .status.paired { background: #e8f5e9; color: #2e7d32; font-weight: bold; }
        .status.error { background: #ffebee; color: #c62828; }
        .help-box { margin-top: 3rem; font-size: 0.8rem; color: #999; border-top: 1px solid #eee; padding-top: 1.5rem; }
    </style>
</head>
<body>
    <div class="container">
        <div class="avatar">üíå</div>
        <h1 id="sender-msg">A message for you!</h1>
        <div class="message" id="instruction">Johnny wants to show you a video on your TV.</div>
        
        <div class="video-box">
            <div class="video-label">The Selection</div>
            <div class="video-title" id="content-info">Ready to play...</div>
        </div>

        <div id="status-box" class="status finding">üîç Finding your TV...</div>

        <div id="action-area" style="display:none; margin-top: 2rem;">
            <button class="btn" onclick="launchVideo()">üì∫ Tap to Play on TV</button>
            <p style="font-size: 0.8rem; color: #666; margin-top: 1rem;">Make sure your TV is turned on!</p>
        </div>

        <div class="help-box">
            <b>Need help?</b><br>
            If the TV doesn't find the video, try opening the "Quickbeam" app on your Roku TV first.
        </div>
    </div>

    <script>
        const linkId = window.location.pathname.split('/').pop();
        let targetDevice = null;
        let linkData = null;

        async function resolveLink() {
            try {
                const res = await fetch(`/api/resolve/${linkId}`);
                linkData = await res.json();
                
                document.getElementById('sender-msg').innerText = `${linkData.senderName || 'Someone'} sent you a video!`;
                document.getElementById('instruction').innerText = `${linkData.senderName || 'Your friend'} wants to show you this on your TV.`;
                document.getElementById('content-info').innerText = linkData.appId === '837' ? 'A YouTube Video' : 'A Special Selection';

                if (linkData.device) {
                    targetDevice = linkData.device;
                    document.getElementById('status-box').innerText = "‚úÖ TV Found & Connected";
                    document.getElementById('status-box').className = "status paired";
                    document.getElementById('action-area').style.display = 'block';
                } else {
                    document.getElementById('status-box').innerText = "‚ùå TV Not Found. Open Quickbeam on Roku.";
                    document.getElementById('status-box').className = "status error";
                }
            } catch (e) {
                document.getElementById('status-box').innerText = "‚ö†Ô∏è Link error. Try again.";
                document.getElementById('status-box').className = "status error";
            }
        }

        async function launchVideo() {
            if (!targetDevice || !linkData) return;
            
            const rokuUrl = `http://${targetDevice.localIp}:8060/launch/${linkData.appId}?contentId=${linkData.contentId}&mediaType=${linkData.mediaType}`;
            
            const originalText = document.querySelector('.btn').innerText;
            document.querySelector('.btn').innerText = "‚ú® Starting...";
            
            try {
                await fetch(rokuUrl, { method: 'POST', mode: 'no-cors' });
                setTimeout(() => {
                    document.querySelector('.btn').innerText = "üé¨ Playing on TV!";
                    setTimeout(() => { document.querySelector('.btn').innerText = originalText; }, 3000);
                }, 1000);
            } catch (e) {
                alert("Failed to reach TV. Check your Wi-Fi.");
                document.querySelector('.btn').innerText = originalText;
            }
        }

        resolveLink();
    </script>
</body>
</html>
